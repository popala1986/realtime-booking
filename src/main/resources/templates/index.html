
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6" lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Rezerwacje miejsc</title>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f9f9f9;
            margin: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        h1 { color: #333; text-align: center; }
        table {
            border-collapse: collapse;
            width: auto;
            background: transparent;
            border-spacing: 0;
            box-shadow: none;
            margin: 24px auto 12px;
            position: relative;
        }
        table > tbody > tr:first-child { display: none !important; }
        table > tbody {
            display: grid;
            gap: 12px 14px;
            justify-content: center;
            align-items: start;
            padding: 28px 16px 16px;
        }
        table::before {
            content: "EKRAN";
            display: block;
            text-align: center;
            font-weight: 600;
            letter-spacing: 3px;
            color: #666;
            background: linear-gradient(to bottom, #ddd, #f7f7f7);
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 10px 18px;
            width: min(520px, 90vw);
            margin: 0 auto 12px;
        }
        table > tbody > tr {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 52px;
            height: 52px;
            border: none;
            background: transparent;
        }
        table > tbody > tr > td { display: none; }
        table > tbody > tr > td:last-child { display: block; padding: 0; border: none; }
        .reserve-btn {
            width: 52px;
            height: 52px;
            border-radius: 12px;
            border: 2px solid #2f7a33;
            background: #4CAF50;
            color: #fff;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 2px 0 rgba(0,0,0,0.12);
            transition: transform .08s ease, background .2s, box-shadow .2s, border-color .2s;
        }
        .reserve-btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.12);
            background: #45a049;
        }
        .reserve-btn:disabled {
            cursor: not-allowed;
            opacity: .9;
        }
        tr.reserved .reserve-btn {
            background: #ff6b6b;
            border-color: #c84d4d;
        }
        tr.reserved .reserve-btn:hover {
            background: #ff6b6b;
            transform: none;
            box-shadow: 0 2px 0 rgba(0,0,0,0.12);
        }
        table > tbody > tr > td:last-child > span[sec\\:authorize="!isAuthenticated()"] {
            display: none !important;
        }
        table > tbody > tr > td:last-child {
            position: relative;
        }
        table > tbody > tr > td:last-child::before {
            content: "";
            display: block;
            width: 52px;
            height: 52px;
            border-radius: 12px;
            border: 2px solid #b5b5b5;
            background: #e9e9e9;
            box-shadow: 0 2px 0 rgba(0,0,0,0.08);
        }
        table > tbody > tr > td:last-child:has(.reserve-btn)::before {
            content: none;
        }
        .user-info, #message { max-width: 800px; text-align: center; }
        #message { margin-top: 10px; font-weight: 600; }
        @media (max-width: 480px) {
            table > tbody > tr,
            .reserve-btn,
            table > tbody > tr > td:last-child::before { width: 44px; height: 44px; }
            table::before { width: min(420px, 92vw); }
        }
    </style>
</head>
<body>
<h1>Rezerwacje miejsc</h1>

<div class="user-info">
    <span sec:authorize="isAuthenticated()">
        Zalogowany jako: <b th:text="${#authentication.name}"></b>
    </span>
    <a sec:authorize="isAuthenticated()" href="/logout">Wyloguj</a>
    <a sec:authorize="!isAuthenticated()" href="/login">Zaloguj się aby rezerwować</a>
</div>

<div id="message"></div>

<table>
    <tr>
        <th>Rząd</th>
        <th>Miejsce</th>
        <th>Status</th>
        <th>Akcja</th>
    </tr>
    <tr th:each="seat : ${seats}"
        th:classappend="${seat.status == T(p.o.realtimebooking.model.SeatStatus).RESERVED} ? 'reserved'">
        <td th:text="${seat.rowNum}">1</td>
        <td th:text="${seat.seatNum}">1</td>
        <td class="status" th:text="${seat.status}">AVAILABLE</td>
        <td>
            <button class="reserve-btn"
                    th:attr="data-id=${seat.id}, title=${'Rząd ' + seat.rowNum + ', Miejsce ' + seat.seatNum}"
                    sec:authorize="isAuthenticated()"
                    th:disabled="${seat.status != T(p.o.realtimebooking.model.SeatStatus).AVAILABLE}">
                Rezerwuj
            </button>
        </td>
    </tr>
</table>

<script>
    (function () {
      const table = document.querySelector("table");
      const tbody = table?.tBodies?.[0];
      if (!tbody) return;

      const allRows = Array.from(tbody.querySelectorAll("tr"));
      if (!allRows.length) return;

      const dataRows = allRows.slice(1);

      const seats = dataRows.map(tr => {
        const tds = tr.querySelectorAll("td");
        const rowNum = parseInt(tds[0]?.textContent?.trim(), 10);
        const seatNum = parseInt(tds[1]?.textContent?.trim(), 10);
        const btn = tr.querySelector(".reserve-btn");
        return { tr, rowNum, seatNum, btn };
      }).filter(s => Number.isFinite(s.rowNum) && Number.isFinite(s.seatNum));

      if (!seats.length) return;

      const maxSeat = seats.reduce((m, s) => Math.max(m, s.seatNum), 0);
      const maxRow  = seats.reduce((m, s) => Math.max(m, s.rowNum), 0);

      const cellSize = 52;
      tbody.style.gridTemplateColumns = `repeat(${maxSeat}, ${cellSize}px)`;
      tbody.style.gridTemplateRows = `repeat(${maxRow}, ${cellSize}px)`;

      seats.forEach(({ tr, rowNum, seatNum, btn }) => {
        tr.style.gridColumn = String(seatNum);
        tr.style.gridRow = String(rowNum);
        if (btn) btn.textContent = String(seatNum);
      });
    })();
</script>

<!--<script>-->
<!--    // POPRAWIONA LOGIKA WEBSOCKET-->
<!--    $(document).ready(function() {-->
<!--        $.get("/csrf-token", function(data) {-->
<!--            const csrfToken = data.token;-->
<!--            const csrfHeader = data.headerName;-->

<!--            const socket = new SockJS('/ws');-->
<!--            const stompClient = Stomp.over(socket);-->

<!--            stompClient.connect({ [csrfHeader]: csrfToken }, function(frame) {-->
<!--                console.log('Połączono: ' + frame);-->

<!--                stompClient.subscribe('/topic/seats/update', function(message) {-->
<!--                    const seatUpdate = JSON.parse(message.body);-->
<!--                    const seatId = seatUpdate.id; // Zmieniono na `.id` aby pasowało do DTO-->

<!--                    const btn = $(`[data-id=${seatId}]`);-->
<!--                    if (btn.length) {-->
<!--                        const row = btn.closest("tr");-->
<!--                        const status = seatUpdate.status;-->

<!--                        // Tutaj odczytujemy numery rzędów i miejsc z wiadomości,-->
<!--                        // które są wysyłane z serwera po modyfikacji kontrolera-->
<!--                        const rowNum = seatUpdate.rowNum;-->
<!--                        const seatNum = seatUpdate.seatNum;-->

<!--                        row.find("td.status").text(status);-->
<!--                        btn.prop("disabled", status !== 'AVAILABLE');-->

<!--                        if (status === 'RESERVED') {-->
<!--                            row.addClass("reserved");-->
<!--                        } else {-->
<!--                            row.removeClass("reserved");-->
<!--                        }-->

<!--                        if (status === 'AVAILABLE') {-->
<!--                            $("#message").text(`Miejsce nr ${seatNum} w rzędzie ${rowNum} zostało zwolnione.`);-->
<!--                        } else if (status === 'RESERVED') {-->
<!--                            $("#message").text(`✅ Miejsce nr ${seatNum} w rzędzie ${rowNum} zostało zarezerwowane.`);-->
<!--                        }-->
<!--                    }-->
<!--                });-->

<!--                $(".reserve-btn").off("click").on("click", function() {-->
<!--                    const seatId = $(this).data("id");-->
<!--                    stompClient.send("/app/reserve/" + seatId, {}, JSON.stringify({ 'id': seatId }));-->
<!--                });-->
<!--            }, function(error) {-->
<!--                console.error("Błąd połączenia STOMP:", error);-->
<!--                $("#message").text("❌ Błąd połączenia. Odśwież stronę.");-->
<!--            });-->
<!--        }).fail(function() {-->
<!--            console.error("Nie udało się pobrać tokenu CSRF.");-->
<!--            $("#message").text("❌ Błąd: Nie można nawiązać bezpiecznego połączenia. Spróbuj odświeżyć stronę.");-->
<!--        });-->
<!--    });-->
<!--</script>-->

<script>
    // POPRAWIONA LOGIKA WEBSOCKET
    $(document).ready(function() {
        $.get("/csrf-token", function(data) {
            const csrfToken = data.token;
            const csrfHeader = data.headerName;

            const socket = new SockJS('/ws');
            const stompClient = Stomp.over(socket);

            stompClient.connect({ [csrfHeader]: csrfToken }, function(frame) {
                console.log('Połączono: ' + frame);

                stompClient.subscribe('/topic/seats/update', function(message) {
                    const seatUpdate = JSON.parse(message.body);
                    const seatId = seatUpdate.id;
                    const status = seatUpdate.status;

                    const btn = $(`[data-id=${seatId}]`);
                    if (btn.length) {
                        const row = btn.closest("tr");
                        row.find("td.status").text(status);
                        btn.prop("disabled", status !== 'AVAILABLE');

                        if (status === 'RESERVED') {
                            row.addClass("reserved");
                        } else {
                            row.removeClass("reserved");
                        }

                        const rowNum = seatUpdate.rowNum;
                        const seatNum = seatUpdate.seatNum;

                        let newMessage = "";
                        if (status === 'AVAILABLE') {
                            newMessage = `Miejsce nr ${seatNum} w rzędzie ${rowNum} zostało zwolnione.`;
                        } else if (status === 'RESERVED') {
                            newMessage = `✅ Miejsce nr ${seatNum} w rzędzie ${rowNum} zostało zarezerwowane.`;
                        }

                        // Dodaj nowy komunikat, nie nadpisuj poprzedniego
                        const messageElement = $("#message");
                        messageElement.append(`<p>${newMessage}</p>`);

                        // Ogranicz liczbę wyświetlanych komunikatów, aby lista nie rosła w nieskończoność
                        if (messageElement.children().length > 5) {
                            messageElement.children().first().remove();
                        }
                    }
                });

                $(".reserve-btn").off("click").on("click", function() {
                    const seatId = $(this).data("id");
                    stompClient.send("/app/reserve/" + seatId, {}, JSON.stringify({ 'id': seatId }));
                });
            }, function(error) {
                console.error("Błąd połączenia STOMP:", error);
                $("#message").text("❌ Błąd połączenia. Odśwież stronę.");
            });
        }).fail(function() {
            console.error("Nie udało się pobrać tokenu CSRF.");
            $("#message").text("❌ Błąd: Nie można nawiązać bezpiecznego połączenia. Spróbuj odświeżyć stronę.");
        });
    });
</script>

</body>
</html>